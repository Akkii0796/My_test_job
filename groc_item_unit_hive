INSERT OVERWRITE TABLE groc_order_item_unit_hive_fact
SELECT fulfill_item_listing_type, 
       fulfill_item_unit_dbd_change_reason, 
       fulfill_item_unit_deliver_actual_time, 
       fulfill_item_unit_dispatch_actual_time, 
       fulfill_item_unit_dispatch_expected_time, 
       fulfill_item_unit_dispatch_service_tier, 
       fulfill_item_unit_id, 
       fulfill_item_unit_is_for_slotted_delivery, 
       fulfill_item_unit_region, 
       fulfill_item_unit_reserve_actual_time, 
       fulfill_item_unit_reserve_expected_time, 
       fulfill_item_unit_ship_actual_time, 
       fulfill_item_unit_ship_expected_time, 
       fulfill_item_unit_status, 
       promise_change_done_at, 
       fulfill_item_service_profile, 
       fulfill_item_unit_deliver_expected_time, 
       fulfill_item_unit_deliver_after_time, 
       fulfill_item_unit_slotted_delivery_breach, 
       fulfill_item_unit_dispatch_after_time, 
       fulfill_item_unit_deliver_date_change_subreason, 
       fulfill_item_unit_deliver_date_change_reason, 
       fulfill_item_unit_granular_shipment_movement_type, 
       order_item_unit_quantity, 
       order_original_billing_amount,
       mrp, 
       gmv, 
       listing_price, 
       exchange_discount_adjustment, 
       order_external_id, 
       order_sales_channel, 
       status, 
       shipment_id, 
       tracking_id, 
       order_id, 
       order_item_id, 
       id, 
	   order_created_at,
       unit_is_rtod, 
       sku, 
       order_item_unit_cancel_date_key, 
       order_item_listing_id_key, 
       order_item_unit_init_promised_date_key,
       order_item_seller_id_key, 
	   source_facility_id,
       source_facility_id_key, 
       shipping_address_id_key, 
       order_item_unit_final_promised_date_key, 
       account_id_key, 
       product_id_key, 
       unit_creation_date_time, 
       shipping_address_pincode_key, 
       order_payment_type, 
       initial_promise_date_time, 
       final_promise_date_time, 
       approved_date_time, 
       marketplace_id, 
	   oms_delivered_date_time,
       fiu_warehouse_id, 
       reservation_status, 
       reservation_created_timestamp, 
       reservation_quantity, 
       reservation_cancelled_timestamp, 
       picklist_display_id, 
       picklist_created_timestamp, 
       picklist_completed_by, 
       picklist_completed_timestamp, 
       ho_created_at, 
       ho_processing_at, 
       ho_ready_for_palletization_at, 
       ho_in_palletization_at, 
       ho_ready_for_handover_at, 
       ho_completed_at, 
       invoice_printed_timestamp, 
       product_key, 
       picklist_item_actual_location_key, 
       cancellation_reason, 
       cancellation_sub_reason, 
       cancellation_date_key, 
       variance_quantity, 
       variance_reason_type, 
       variance_created_date_key, 
       cancellation_derived_reason, 
	   manual_reschedule_count, 
       autoheal_reschedule_count, 
       reattempt_fc_breach_reschedule_count,
	   manual_reschedule_count+autoheal_reschedule_count+reattempt_fc_breach_reschedule_count as total_reschdule_count,
	   sla_given_in_days,
	   speed_delivered_in_days,
	    case when (cancellation_derived_reason='MarketPlace'  and cancellation_reason='mp_cancellation' and variance_reason_type 
			in ('Stock Take Loss','Picklist item lost','Catalog Correction'))  then 'FC_Cancelled' 
			when cancellation_derived_reason='MarketPlace' and cancellation_reason='mp_cancellation'  then 'FF_Cancelled'
			else null end as fc_cancellation_flag,
       CASE 
              WHEN status= 'RETURNED' 
              AND    oms_delivered_date_time IS NOT NULL THEN 1 
              ELSE 0 
       END AS rvp_flag,
	   user_lockin_state
FROM   ( 
                 SELECT    ff.fulfill_item_listing_type, 
                           ff.fulfill_item_unit_dbd_change_reason, 
                           ff.fulfill_item_unit_deliver_actual_time, 
                           ff.fulfill_item_unit_dispatch_actual_time, 
                           ff.fulfill_item_unit_dispatch_expected_time, 
                           ff.fulfill_item_unit_dispatch_service_tier, 
                           ff.fulfill_item_unit_id, 
                           ff.fulfill_item_unit_is_for_slotted_delivery, 
                           ff.fulfill_item_unit_region, 
                           ff.fulfill_item_unit_reserve_actual_time, 
                           ff.fulfill_item_unit_reserve_expected_time, 
                           ff.fulfill_item_unit_ship_actual_time, 
                           ff.fulfill_item_unit_ship_expected_time, 
                           ff.fulfill_item_unit_status, 
                           ff.promise_change_done_at, 
                           ff.fulfill_item_service_profile, 
                           ff.fulfill_item_unit_deliver_expected_time, 
                           ff.fulfill_item_unit_deliver_after_time, 
                           ff.fulfill_item_unit_slotted_delivery_breach, 
                           ff.fulfill_item_unit_dispatch_after_time, 
                           ff.fulfill_item_unit_deliver_date_change_subreason, 
                           ff.fulfill_item_unit_deliver_date_change_reason, 
                           ff.fulfill_item_unit_granular_shipment_movement_type, 
                           oms.units AS order_item_unit_quantity, 
                           oms.order_original_billing_amount, 
						   oms.user_lockin_state,
                           oms.mrp, 
                           oms.gmv, 
                           oms.listing_price, 
                           oms.exchange_discount_adjustment, 
                           oms.order_external_id, 
                           oms.order_sales_channel, 
                           oms.status, 
                           oms.shipment_id, 
                           oms.tracking_id, 
                           oms.order_id, 
                           oms.order_item_id, 
                           oms.id, 
						   oms.order_created_at,
                           oms.unit_is_rtod, 
                           oms.sku, 
                           Lookup_date(oms.cancel_date_time)          AS order_item_unit_cancel_date_key,
                           oms.listing_id_key                         AS order_item_listing_id_key,
                           Lookup_date(oms.initial_promise_date_time) AS order_item_unit_init_promised_date_key,
                           oms.seller_id_key                          AS order_item_seller_id_key,
						   oms.source_facility_id,
                           oms.source_facility_id_key, 
                           oms.shipping_address_id_key, 
                           Lookup_date(oms.final_promise_date_time) order_item_unit_final_promised_date_key,
                           oms.account_id_key, 
                           oms.product_id_key, 
                           oms.unit_creation_date_time, 
                           oms.shipping_address_pincode_key, 
                           oms.order_payment_type, 
                           oms.initial_promise_date_time, 
                           oms.final_promise_date_time, 
                           oms.approved_date_time, 
                           oms.marketplace_id, 
                           oms.unhold_date_time, 
						   oms.oms_delivered_date_time,
                           fc.fiu_warehouse_id, 
                           fc.reservation_status, 
                           fc.reservation_created_timestamp, 
                           fc.reservation_quantity, 
                           fc.reservation_cancelled_timestamp, 
                           fc.picklist_display_id, 
                           fc.picklist_created_timestamp, 
                           fc.picklist_completed_by, 
                           fc.picklist_completed_timestamp, 
                           fc.ho_created_at, 
                           fc.ho_processing_at, 
                           fc.ho_ready_for_palletization_at, 
                           fc.ho_in_palletization_at, 
                           fc.ho_ready_for_handover_at, 
                           fc.ho_completed_at, 
                           fc.invoice_printed_timestamp, 
                           fc.product_key, 
                           fc.picklist_item_actual_location_key, 
                           cancelled.cancellation_reason, 
                           cancelled.cancellation_sub_reason, 
                           cancelled.cancellation_date_key,
						   var.variance_quantity,
                           var.variance_reason_type, 
                           var.variance_created_date_key, 
                           cancellation_reason_dim.cancellation_derived_reason, 
                           cpd_change.manual_reschedule_count, 
                           cpd_change.autoheal_reschedule_count, 
                           cpd_change.reattempt_fc_breach_reschedule_count,
						   datediff(OMS.initial_promise_date_time,OMS.order_created_at) as sla_given_in_days,
						   datediff(OMS.oms_delivered_date_time,OMS.order_created_at) as speed_delivered_in_days
                 FROM      ( 
                                  SELECT units, 
                                         order_original_billing_amount, 
										 user_lockin_state,
                                         mrp, 
                                         gmv, 
                                         listing_price, 
                                         exchange_discount_adjustment, 
                                         order_external_id, 
                                         order_sales_channel, 
                                         status, 
                                         shipment_id, 
                                         tracking_id, 
                                         order_id, 
                                         order_item_id, 
                                         id,
										 order_created_at,
                                         unit_is_rtod, 
                                         sku, 
                                         cancel_date_time, 
                                         listing_id_key, 
                                         initial_promise_date_time, 
                                         seller_id_key, 
										 source_facility_id,
                                         source_facility_id_key, 
										 COALESCE(deliver_date_time,delivered_date_time) as oms_delivered_date_time,
                                         shipping_address_id_key, 
                                         final_promise_date_time, 
                                         account_id_key, 
                                         product_id_key, 
                                         unit_creation_date_time, 
                                         shipping_address_pincode_key, 
                                         order_payment_type,  
                                         approved_date_time, 
                                         marketplace_id, 
                                         unhold_date_time										 										 
                                  FROM   bigfoot_external_neo.cp_bi_prod_sales__forward_unit_fact
                                  WHERE  marketplace_id = 'GROCERY') OMS 
                 LEFT JOIN 
                           ( 
                                  SELECT order_item_unit_id_string,
										 warehouse_fulfill_reference_id_customer,
										 fulfill_item_listing_type, 
                                         fulfill_item_unit_dbd_change_reason, 
                                         fulfill_item_unit_deliver_actual_time, 
                                         fulfill_item_unit_dispatch_actual_time, 
                                         fulfill_item_unit_dispatch_expected_time, 
                                         fulfill_item_unit_dispatch_service_tier, 
                                         fulfill_item_unit_id, 
                                         fulfill_item_unit_is_for_slotted_delivery, 
                                         fulfill_item_unit_region, 
                                         fulfill_item_unit_reserve_actual_time, 
                                         fulfill_item_unit_reserve_expected_time, 
                                         fulfill_item_unit_ship_actual_time, 
                                         fulfill_item_unit_ship_expected_time, 
                                         fulfill_item_unit_status, 
                                         promise_change_done_at, 
                                         fulfill_item_service_profile, 
                                         fulfill_item_unit_deliver_expected_time, 
                                         fulfill_item_unit_deliver_after_time, 
                                         fulfill_item_unit_slotted_delivery_breach, 
                                         fulfill_item_unit_dispatch_after_time, 
                                         fulfill_item_unit_deliver_date_change_subreason, 
                                         fulfill_item_unit_deliver_date_change_reason, 
                                         fulfill_item_unit_granular_shipment_movement_type 
                                  FROM   bigfoot_external_neo.scp_fulfillment__fulfillment_unit_hive_fact ) FF 
                 ON        oms.id = ff.order_item_unit_id_string 
                 LEFT JOIN 
                           ( 
                                  SELECT fulfill_item_unit_id,
										 fiu_warehouse_id, 
                                         reservation_status, 
                                         reservation_created_timestamp, 
                                         reservation_quantity, 
                                         reservation_cancelled_timestamp, 
                                         picklist_display_id, 
                                         picklist_created_timestamp, 
                                         picklist_completed_by, 
                                         picklist_completed_timestamp, 
                                         ho_created_at, 
                                         ho_processing_at, 
                                         ho_ready_for_palletization_at, 
                                         ho_in_palletization_at, 
                                         ho_ready_for_handover_at, 
                                         ho_completed_at, 
                                         invoice_printed_timestamp, 
                                         product_key, 
                                         picklist_item_actual_location_key 
                                  FROM   bigfoot_external_neo.scp_warehouse__fc_outbound_breach_unit_l2_hive_fact
                                  WHERE  marketplace_id = 'GROCERY' ) FC 
                 ON        ff.fulfill_item_unit_id = fc.fulfill_item_unit_id 
                 LEFT JOIN bigfoot_external_neo.scp_oms__cancellation_item_hive_3_0_fact CANCELLED
                 ON        cancelled.unit_id=ff.order_item_unit_id_string 
                 LEFT JOIN bigfoot_common.cancellation_reason_dim cancellation_reason_dim 
                 ON        cancelled.cancellation_reason_key = cancellation_reason_dim.cancellation_reason_dim_key
                 LEFT JOIN 
                           ( 
                                     SELECT    reservation_fulfill_reference_id, 
                                               variance_quantity, 
                                               variance_created_date_key, 
                                               variance_reason_type 
                                     FROM      bigfoot_external_neo.scp_warehouse__fc_variance_item_hive_l0_fact
                                     LEFT JOIN bigfoot_external_neo.scp_warehouse__fc_variance_reason_hive_dim
                                     ON        fc_variance_reason_hive_dim_key =variance_reason_dim_key
                                     LEFT JOIN bigfoot_external_neo.scp_warehouse__fc_reservation_l0_hive_fact
                                     ON        variance_inventory_item_id=reservation_inventory_item_id
                                     WHERE     variance_reason_type IN ('Picklist item lost', 
                                                                        'Stock Take Loss', 
                                                                        'Catalog Correction')) VAR
                 ON        var.reservation_fulfill_reference_id = ff.warehouse_fulfill_reference_id_customer
                 LEFT JOIN 
                           ( 
                                    SELECT   fulfill_item_unit_id, 
                                             Sum( 
                                             CASE 
                                                      WHEN sub_reason = 'GROCERY_RESCHEDULE_MANUAL' THEN unit_reschedule_count
                                                      ELSE 0 
                                             END) AS manual_reschedule_count, 
                                             Sum( 
                                             CASE 
                                                      WHEN sub_reason = 'GROCERY_RESCHEDULE_SLOT_BREACHED' THEN unit_reschedule_count
                                                      ELSE 0 
                                             END) AS autoheal_reschedule_count, 
                                             Sum( 
                                             CASE 
                                                      WHEN sub_reason = 'SLOT_CHANGED' THEN unit_reschedule_count
                                                      ELSE 0 
                                             END) AS reattempt_fc_breach_reschedule_count 
                                    FROM     bigfoot_external_neo.scp_ekl__groc_autoheal_manual_reschedules_fact
                                    GROUP BY fulfill_item_unit_id ) cpd_change 
                 ON        cpd_change.fulfill_item_unit_id = ff.fulfill_item_unit_id) a;	